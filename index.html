<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Graph Editor beta 0.1</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.3/svg.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/svg.draggy.js/1.1.1/svg.draggy.min.js"></script>
    <script type="text/javascript" src="plugins/connectable/svg.connectable.js"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <style>
        .svg-stage {
            border: 1px solid black;
            margin: 10px 5px 5px 0;
        }
    </style>
</head>
<body>
<h2>Graph Editor beta 0.1</h2>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6">
            <div id="message-alert" class="alert" style="display: none" role="alert">
                <button id="alert-close-btn" type="button" class="close" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <span id="message-alert-text"></span>
            </div>
        </div>
        <div class="col-md-1">
            <button id="validation-btn" type="button" class="btn btn-info float-right">Validation</button>
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-info float-left">Calculate</button>
        </div>
    </div>
    <div class="row">
        <div class="col-md-8">
            <div class="row">
                <div class="container-fluid" oncontextmenu="return false;">
                    <svg id="stage" class="svg-stage"></svg>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="row">
                <h3>Table name:</h3>
            </div>
            <div class="row">
                <table class="table">
                    <thead>
                    <tr>
                        <th scope="col">Source</th>
                        <th scope="col">Target</th>
                        <th scope="col">Spend time</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td contenteditable='true'>Mark</td>
                        <td>Otto</td>
                        <td contenteditable='true'>@mdo</td>
                    </tr>
                    <tr>
                        <td>Jacob</td>
                        <td>Thornton</td>
                        <td contenteditable='true'>@fat</td>
                    </tr>
                    <tr>
                        <td>Larry</td>
                        <td>the Bird</td>
                        <td contenteditable='true'>@twitter</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="container">
                <div class="row">
                    <h3>Table name:</h3>
                </div>
                <div class="row">
                    <table class="table">
                        <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Previous</th>
                            <th scope="col">Next</th>
                            <th scope="col">#</th>
                            <th scope="col">#</th>
                            <th scope="col">#</th>
                            <th scope="col">#</th>
                            <th scope="col">#</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <th scope="row">1</th>
                            <td>Mark</td>
                            <td>Otto</td>
                            <td>Otto</td>
                            <td>Otto</td>
                            <td>@mdo</td>
                            <td>@mdo</td>
                            <td>@mdo</td>
                        </tr>
                        <tr>
                            <th scope="row">2</th>
                            <td>Mark</td>
                            <td>Otto</td>
                            <td>Otto</td>
                            <td>Otto</td>
                            <td>@mdo</td>
                            <td>@mdo</td>
                            <td>@mdo</td>
                        </tr>
                        <tr>
                            <th scope="row">3</th>
                            <td>Mark</td>
                            <td>Otto</td>
                            <td>Otto</td>
                            <td>Otto</td>
                            <td>@mdo</td>
                            <td>@mdo</td>
                            <td>@mdo</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<script>
    var counter = -1;

    var candidateNode = null;
    var works = [];

    const nodeColor = '#C2185B';

    var svg = SVG('stage').size("100%", 900);
    var nodes = svg.group();

    svg.dblclick(function (evt) {
        let e = evt.target;
        let dim = e.getBoundingClientRect();

        let x = evt.clientX - dim.left;

        let y = evt.clientY - dim.top;

        let currentNodeNumber = ++counter;
        var node = nodes.group().translate(x, y).draggy();
        node.circle(70)
            .fill(nodeColor)
            .opacity(0.8);

        node.on('contextmenu', function () {
            let nodeNumber = $(this.node).find('text').html();
            this.remove();
            works = $.grep(works, function (work) {
                if (work.source == nodeNumber || work.target == nodeNumber) {
                    $('#' + work.id).remove();
                    return false;
                } else {
                    return true;
                }
            });

            works.forEach(function (work) {
                    if (work.source > nodeNumber) {
                        work.source--;
                    }
                    if (work.target > nodeNumber) {
                        work.target--;
                    }
                }
            );

            $('.node-number').each(function () {
                let currentValue = $(this).html();
                if (nodeNumber < currentValue) {
                    $(this).html(--currentValue)
                }
            });
            counter--;
        });

        node.plain(currentNodeNumber)
            .attr("class", "node-number")
            .font({fill: '#000000', family: 'Inconsolata'});
        node.click(function (evt) {
            if (candidateNode === this) {
                this.children()[0].fill({color: nodeColor});
                candidateNode = null;
            } else if (candidateNode) {

                let currentValue = this.children()[1].node.textContent;
                let previousValue = candidateNode.children()[1].node.textContent;

                if (currentValue < previousValue) {
                    showAlert("Переход из большего в меньшее не возможен!", "alert-danger");
                } else {
                    let connectable = candidateNode.connectable({
                        marker: 'default',
                        targetAttach: 'perifery',
                        sourceAttach: 'perifery',
                        color: '#2a88c9'
                    }, this);

                    let connectorId = $(connectable.connector.node).attr("id");
                    works.push(
                        {
                            id: connectorId,
                            source: previousValue,
                            target: currentValue
                        }
                    );

                    this.children()[0].fill({color: nodeColor});
                    candidateNode.children()[0].fill({color: nodeColor});
                    candidateNode = null;
                }
            } else {
                candidateNode = this;
                candidateNode.children()[0].fill({color: '#b4ff47'})
            }
        });
    });

    $("svg>g").on('contextmenu', 'path', function (e) {
        let connectorId = $(this).attr("id");
        works = $.grep(works, function (work) {
            return work.id !== connectorId;
        });
        $(this).remove();
    });


    $("#validation-btn").click(function (e) {
        var states = [];
        for (let i = 0; i <= counter; i++) {
            let previous = [];
            let next = [];
            works.forEach(function (work) {
                if (i == work.target) {
                    previous.push(work.source);
                }
                if (i == work.source) {
                    next.push(work.target);
                }
            });

            states.push(
                {
                    id: i,
                    prev: previous,
                    next: next
                }
            )
        }

        var msg = "";
        states.forEach(function (state) {
            if (state.id == 0 && (state.prev.length > 0 || state.next.length == 0)) {
                msg += "Состояние <strong>0</strong> не начальное! </br>";
            }

            if (state.id == counter && (state.next.length > 0 || state.prev.length == 0)) {
                msg += "Состояние <strong>" + counter + "</strong> не конечное!</br>";
            }

            if (state.id > 0 && state.id < counter && (state.next.length == 0 || state.prev.length == 0)) {
                msg += "Состояние  <strong>" + state.id + "</strong> не промежуточное!</br>";
            }
        });

        if (counter < 0) {
            showAlert("Нарисуйте ниже сетевую модель", "alert-warning")
        } else if (msg.length == 0) {
            showAlert("Сетевая модель валидна. В таблицу работ введите длительности", "alert-success")
        } else {
            showAlert(msg, "alert-danger");
        }
    });

    function showAlert(text, type) {
        let alert = $("#message-alert");
        alert.removeClass("alert-danger");
        alert.removeClass("alert-success");
        alert.css("display", "block");
        $("#message-alert-text").html(text);
        alert.addClass(type);
    }

    $("#alert-close-btn").click(function (e) {
        let alert = $("#message-alert");
        alert.removeClass("alert-danger");
        alert.removeClass("alert-success");
        alert.css("display", "none");
    });


</script>
</body>
</html>